import type { GraphData, VulnerabilityRating } from '@/pipeline/types';
import type { PresetConfig, NodeStyleOverride, EdgeStyleOverride } from './index';
import { RATING_COLORS, DIM_OPACITY } from '@/theme/palette';

/**
 * Vulnerability preset: "Where are the risks?"
 *
 * Meta challenge nodes: sized by severity (same mapping as Impact preset)
 *
 * Highlighted edges:
 * - edgeType === 'vulnerability_rating' or 'model_meta_vulnerability'
 * - Color by rating: H = red, M = amber, L = green
 * - lineWidth: 2
 *
 * All other edges: dimmed to DIM_OPACITY
 * Other nodes (not meta_challenge): slightly dimmed (opacity 0.4)
 */
export function createVulnerabilityPreset(data: GraphData): PresetConfig {
  const nodeStyles = new Map<string, NodeStyleOverride>();
  const edgeStyles = new Map<string, EdgeStyleOverride>();

  const severityMap: Record<string, number> = {
    'Critical': 60,
    'High': 50,
    'Moderate-High': 45,
    'Moderate': 40,
  };

  // Size meta_challenge nodes by severity, dim others
  for (const node of data.canvasNodes) {
    if (node.type === 'meta_challenge') {
      const severity = node.data.severity as string | undefined;

      if (severity && severityMap[severity]) {
        nodeStyles.set(node.id, {
          size: severityMap[severity],
          opacity: 1.0,
        });
      } else {
        nodeStyles.set(node.id, { opacity: 1.0 });
      }
    } else {
      // Dim all non-meta-challenge nodes
      nodeStyles.set(node.id, { opacity: 0.4 });
    }
  }

  // Highlight vulnerability edges
  for (const edge of data.edges) {
    if (edge.edgeType === 'vulnerability_rating' || edge.edgeType === 'model_meta_vulnerability') {
      const rating = edge.data.rating as VulnerabilityRating | undefined;

      if (rating && (rating === 'H' || rating === 'M' || rating === 'L')) {
        edgeStyles.set(edge.id, {
          stroke: RATING_COLORS[rating],
          lineWidth: 2,
          opacity: 1.0,
        });
      } else {
        // Vulnerability edge without valid rating â†’ still highlight
        edgeStyles.set(edge.id, {
          lineWidth: 2,
          opacity: 1.0,
        });
      }
    } else {
      // Dim all other edges
      edgeStyles.set(edge.id, { opacity: DIM_OPACITY });
    }
  }

  return {
    nodeStyles,
    edgeStyles,
    description: 'Where are the risks?',
  };
}
